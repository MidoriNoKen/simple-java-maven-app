node {
    stage('Checkout') {
        checkout scm
    }
    stage('Build and Test') {
        try {
            sh 'mvn -B -DskipTests clean package'
            sh 'mvn test'
            junit 'target/surefire-reports/*.xml'
        } catch (Exception e) {
            currentBuild.result = 'FAILURE'
            throw e
        }
    }
    stage('Deploy to Heroku') {
        input message: 'Lanjutkan ke tahap Deploy ke Heroku?',
            ok: 'Proceed',
            cancel: 'Abort'

        if (params.input == 'Proceed') {
            withCredentials([string(credentialsId: 'HEROKU_API_KEY', variable: 'HEROKU_API_KEY')]) {
                sh 'heroku container:login'
                sh 'heroku container:push web --app submission-cicd-pipeline-midorinoken'
                sh 'heroku container:release web --app submission-cicd-pipeline-midorinoken'
            }
            echo 'Application is now deployed to Heroku.'
        }
    }
}
